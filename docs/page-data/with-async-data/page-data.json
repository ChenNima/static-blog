{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/with-async-data","result":{"data":{"markdownRemark":{"html":"<p>åœ¨Reactä¸­ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨äº†Reduxæˆ–å…¶ä»–çŠ¶æ€ç®¡ç†æ¡†æ¶ï¼Œéƒ½æ— æ³•é¿å…åœ¨ç»„ä»¶ä¸­å¤„ç†å¼‚æ­¥è¯·æ±‚ã€‚åœ¨ä¸ä½¿ç”¨<code class=\"language-text\">React Hooks</code>çš„æƒ…å†µä¸‹ï¼Œå…¶å…¸å‹çš„æµç¨‹ä¸ºï¼š</p>\n<ul>\n<li>åœ¨<code class=\"language-text\">componentDidMount</code>ä¸­å‘èµ·å¼‚æ­¥è¯·æ±‚</li>\n<li>è°ƒç”¨<code class=\"language-text\">setState</code>åœ¨stateä¸­ç»´æŠ¤è¯·æ±‚çš„loadingçŠ¶æ€ï¼Œå¹¶æ ¹æ®æ­¤çŠ¶æ€æ¸²æŸ“åŠ è½½åŠ¨ç”»</li>\n<li>åœ¨å¼‚æ­¥è¯·æ±‚resolveçš„æ—¶å€™è°ƒç”¨<code class=\"language-text\">setState</code>å°†æ•°æ®æ”¾åˆ°stateä¸­ï¼Œå¹¶å°†loadingçŠ¶æ€ç½®ä¸ºfalse</li>\n<li>å¦‚æœå¼‚æ­¥è¯·æ±‚å­˜åœ¨å¼‚å¸¸ï¼Œåˆ™éœ€è¦å¤„ç†å¼‚å¸¸å¹¶æ¸²æŸ“å¯¹åº”çš„å¼‚å¸¸çŠ¶æ€</li>\n</ul>\n<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹éå¸¸çç¢ï¼Œå¦‚æœé¡¹ç›®ä¸­æœ‰å¾ˆå¤šå¼‚æ­¥ç»„ä»¶ï¼Œåˆ™æ¯ä¸ªç»„ä»¶éƒ½è¦é‡å¤åœ°å†™ä¸€æ¬¡ä»¥ä¸Šæµç¨‹ã€‚\nåŒæ—¶ï¼Œè¿™ä¸ªæµç¨‹å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>\n<ol>\n<li>å¦‚æœç»„ä»¶<code class=\"language-text\">unmount</code>ä¹‹åå¼‚æ­¥è¯·æ±‚æ‰resolveï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ”¶åˆ°<code class=\"language-text\">Warning: Canâ€™t call setState (or forceUpdate) on an unmounted component.</code>è­¦å‘Š</li>\n<li>åœ¨å®ç°ç±»ä¼¼äº<code class=\"language-text\">typeahead</code>ç±»å‹çš„autocompleteç»„ä»¶æˆ–æ˜¯å…¶ä»–çš„ä¼šé¢‘ç¹å‘ç”Ÿå¼‚æ­¥è¯·æ±‚çš„ç»„ä»¶ä¸­ï¼Œæœ‰å¯èƒ½ä¼šå‘ç”Ÿè¯·æ±‚å…ˆå‘ååˆ°çš„é—®é¢˜ï¼šå…ˆå‘çš„è¯·æ±‚æ¯”åå‘çš„è¯·æ±‚æ›´æ…¢resolveï¼Œå¯¼è‡´æœ€åä¸€æ¬¡æ¸²æŸ“ç»“æœä½¿ç”¨äº†ä¹‹å‰å·²ç»è¿‡æœŸçš„è¾“å…¥</li>\n<li>ç»„ä»¶é™¤è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ä¹‹å¤–è¿˜éœ€è¦ç»´æŠ¤æ•´å¥—å¼‚æ­¥è¯·æ±‚æµç¨‹ã€‚è¿åäº†å‡½æ•°å¼ç¼–ç¨‹ä¸­<code class=\"language-text\">â€œçº¯â€</code>çš„æ¦‚å¿µã€‚ä¸€ä¸ªä¼˜ç§€çš„çº¯ç»„ä»¶åº”è¯¥ä»…æœ‰è¾“å…¥å’Œè¾“å‡ºï¼šé‡å¤åŒä¸€ä¸ªè¾“å…¥åº”è¯¥å¹‚ç­‰åœ°è¿”å›åŒä¸€ä¸ªæ¸²æŸ“ç»“æœ</li>\n</ol>\n<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å¼‚æ­¥é€»è¾‘æŠ½è±¡åˆ°ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸­ï¼Œå¹¶ä¿æŒçœŸæ­£æ¸²æŸ“ä¸šåŠ¡é€»è¾‘çš„ç»„ä»¶è¶³å¤Ÿ<code class=\"language-text\">â€œçº¯â€</code>ï¼Œå¹¶ä¸”ä½¿ç”¨Typescriptä½¿propsç±»å‹æ›´ä¸ºæ¸…æ™°ã€‚\næˆ‘ä»¬æŠŠè¿™ä¸ªHOCå«åš<code class=\"language-text\">withAsyncData</code>,æºç å¯ä»¥åœ¨<a href=\"https://github.com/ChenNima/blog-example/blob/master/front-end/withAsyncData.tsx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">è¿™é‡Œ</a>çœ‹åˆ°ã€‚</p>\n<p>ç»è¿‡åŒ…è£…åçš„ç»„ä»¶æ€»ä½“ç»“æ„å¦‚ä¸‹å›¾ï¼š\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 571px; '>\n      <a class='gatsby-resp-image-link' href='/static/a32c40223fd89494c691be608c55cfa8/ffaf9/arch.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 85.71428571428571%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwX/xAAXAQEBAQEAAAAAAAAAAAAAAAACAAED/9oADAMBAAIQAxAAAAH2oqTdWCqwNo6Z/8QAFxABAQEBAAAAAAAAAAAAAAAAAQAgIf/aAAgBAQABBQJh7MGf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAQAQEf/aAAgBAgEBPwHCyf/EABcQAAMBAAAAAAAAAAAAAAAAAAABMDH/2gAIAQEABj8CMcP/xAAbEAEBAAEFAAAAAAAAAAAAAAABADEQESFxsf/aAAgBAQABPyFm2F6iYDDMg8+RjUv/2gAMAwEAAgADAAAAED/HvP/EABcRAAMBAAAAAAAAAAAAAAAAAAABECH/2gAIAQMBAT8Q0UZ//8QAGBEAAwEBAAAAAAAAAAAAAAAAAAEhMVH/2gAIAQIBAT8QXBjjg9MH/8QAHBABAAICAwEAAAAAAAAAAAAAAQAREDEhQVGh/9oACAEBAAE/ELQfR2lsLR2iH1lhxcsBpdcXLAivAYnbjWf/2Q=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='æ€»ä½“ç»“æ„' title='æ€»ä½“ç»“æ„' src='/static/a32c40223fd89494c691be608c55cfa8/ffaf9/arch.jpg' srcset='/static/a32c40223fd89494c691be608c55cfa8/e52aa/arch.jpg 175w,\n/static/a32c40223fd89494c691be608c55cfa8/70ebb/arch.jpg 350w,\n/static/a32c40223fd89494c691be608c55cfa8/ffaf9/arch.jpg 571w' sizes='(max-width: 571px) 100vw, 571px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<h1>ğŸ”¨ æ„å»ºHOC</h1>\n<h3><strong>1. åˆå§‹çŠ¶æ€</strong></h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">WithAsyncData</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">Child</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">class</span> <span class=\"token class-name\">WithAsyncData</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n    mounted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      isLoadingData<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>æˆ‘ä»¬çš„HOCæ¥å—ä¸€ä¸ªReact Componentä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªç»è¿‡åŒ…è£¹çš„Componentã€‚åˆå§‹æˆ‘ä»¬æ‹¥æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼šmountedå’ŒisLoadingDataã€‚é¡¾åæ€ä¹‰ä»–ä»¬æ˜¯ç”¨æ¥ç»´æŠ¤ç»„ä»¶mountçŠ¶æ€å’Œæ•°æ®loadingçŠ¶æ€çš„ã€‚ç”±äºmountçŠ¶æ€å¹¶ä¸ç›´æ¥å½±å“æ¸²æŸ“ç»“æœè€Œåªæ˜¯ç”¨æ¥æŒ‡å¯¼æ˜¯å¦åº”è¯¥è°ƒç”¨<code class=\"language-text\">setState</code>ï¼Œæˆ‘ä»¬é€‰æ‹©æŠŠå®ƒæ”¾åœ¨<code class=\"language-text\">this</code>ä¸Šè€Œä¸æ˜¯<code class=\"language-text\">state</code>é‡Œã€‚</p>\n<h3><strong>2. æ¥å—å¼‚æ­¥æ•°æ®</strong></h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">static</span> <span class=\"token function\">getDerivedStateFromProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props<span class=\"token punctuation\">,</span> state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// cleanDataè¿™ä¸ªå±æ€§ç”¨æ¥è¡¨ç¤ºæ˜¯å¦åœ¨æ¯æ¬¡æ›´æ–°æ•°æ®ä¹‹åå°†ä¸Šæ¬¡çš„æ•°æ®ä¿å­˜åœ¨lastDataè¿™ä¸ªstateä¸­ï¼Œä¸»è¦ç”¨äºinfinityScrollè¿™ç§åœºæ™¯ã€‚</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">,</span> cleanData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> lastData <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å¦‚æœdataæ²¡æœ‰æ”¹å˜ï¼Œç›´æ¥è·³è¿‡</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> data <span class=\"token operator\">===</span> lastData <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// å¦‚æœdataæ˜¯åŒæ­¥æ•°æ®ï¼Œé‚£ä¹ˆå°†isLoadingDataç½®ä¸ºfalseï¼Œç›´æ¥å°†dataä¼ é€’ç»™æ¸²æŸ“ç»„ä»¶</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isThenable</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      lastData<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n      data<span class=\"token punctuation\">,</span>\n      dataPromise<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n      isLoadingData<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å¦‚æœdataæ˜¯å¼‚æ­¥è¯·æ±‚ï¼ˆè¿™é‡Œç”¨thenableè¡¨ç¤ºï¼‰ï¼Œé‚£ä¹ˆå°†isLoadingDataç½®ä¸ºtrueï¼Œå‡†å¤‡è¯·æ±‚å¼‚æ­¥æ•°æ®</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      lastData<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n      dataPromise<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\n      isLoadingData<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>cleanData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newState<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> newState<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ä½¿ç”¨<code class=\"language-text\">getDerivedStateFromProps</code>é’©å­å¯ä»¥åœ¨æ¯æ¬¡æ¸²æŸ“ä¹‹å‰æ¥æ”¶å¤–éƒ¨ä¼ è¿›æ¥çš„<code class=\"language-text\">data</code>ï¼Œåœ¨è¿™é‡Œ<code class=\"language-text\">data</code>å¯ä»¥æ˜¯ä¸€ä¸ªåŒæ­¥æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¼‚æ­¥<code class=\"language-text\">Promise</code>ã€‚</p>\n<h3><strong>3. å¤„ç†å¼‚æ­¥æ•°æ®</strong></h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// è®°å½•ç»„ä»¶mountçŠ¶æ€</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolveAsyncData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">componentDidUpdate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prevProps<span class=\"token punctuation\">,</span> prevState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ä»…åœ¨dataPromiseæ”¹å˜çš„æƒ…å†µä¸‹æ‰resolveå¼‚æ­¥æ•°æ®</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise <span class=\"token operator\">!==</span> prevState<span class=\"token punctuation\">.</span>dataPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolveAsyncData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">shouldKeepResult</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ä»…ä»…åœ¨å½“å‰Promiseæ˜¯ç»„ä»¶æ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªPromiseï¼Œå¹¶ä¸”ç»„ä»¶å°šæœªunmountçš„æƒ…å†µä¸‹æ‰ä¼šå°†dataçœŸæ­£resolveç»™æ¸²æŸ“ç»„ä»¶</span>\n  <span class=\"token keyword\">return</span> dataPromise <span class=\"token operator\">===</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>dataPromise <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token function\">resolveAsyncData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataPromise</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> dataPromise<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// åœ¨æ­¤å¤„é—­åŒ…è®¿é—®dataPromiseï¼Œå³å¯å°†resolveçš„Promiseä¸ç»„ä»¶æœ€åæ¥æ”¶åˆ°çš„Promiseè¿›è¡Œå¯¹æ¯”</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">shouldKeepResult</span><span class=\"token punctuation\">(</span>dataPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>onDataReady<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// åœ¨æ•°æ®resolveä¹‹åï¼Œå¤–éƒ¨ç»„ä»¶çš„å›è°ƒé’©å­</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">onDataReady</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        data<span class=\"token punctuation\">,</span>\n        isLoadingData<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        dataPromise<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        dataError<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">shouldKeepResult</span><span class=\"token punctuation\">(</span>dataPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>onDataError<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// åœ¨æ•°æ®resolve å¤±è´¥ä¹‹åï¼Œå¤–éƒ¨ç»„ä»¶çš„å›è°ƒé’©å­</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">onDataError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        dataError<span class=\"token operator\">:</span> error<span class=\"token punctuation\">,</span>\n        isLoadingData<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        dataPromise<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ç»„ä»¶unmountä¹‹å‰è®°å½•çŠ¶æ€</span>\n<span class=\"token function\">componentWillUnmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mounted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3><strong>4. ä¼ é€’æ•°æ®ç»™å­ç»„ä»¶</strong></h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// å¯¹å­ç»„ä»¶æ¥è¯´ï¼Œdataæ˜¯åŒæ­¥æ•°æ®ã€‚å°†å¤–éƒ¨ä¼ å…¥çš„promiseåˆ é™¤å¹¶æ›¿æ¢ä¸ºåŒæ­¥æ•°æ®ï¼ŒåŒæ—¶å°†loadingçŠ¶æ€ç­‰stateä¹Ÿä¸€åŒä¼ é€’</span>\n    <span class=\"token operator\">...</span><span class=\"token function\">omit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Child</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">props</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†æ•´ä¸ªHOCçš„æ„å»ºï¼Œå®é™…ä½¿ç”¨æ—¶æ•ˆæœå¦‚ä¸‹</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> promise <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">(resolve => setTimeout(() => </span><span class=\"token punctuation\">{</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hello world'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">, 200));\n\nconst RenderComponent = withAsyncData(({ data, isLoadingData }: { data: string, isLoadingData?: boolean }) => (\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span>isLoadingData <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">loading</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token operator\">!</span>isLoadingData <span class=\"token operator\">&amp;&amp;</span> data <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n));\nconst ParentComponent = () => (\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RenderComponent</span></span> <span class=\"token attr-name\">data</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>promise<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n);</span></code></pre></div>\n<p><strong>å¯ä»¥çœ‹åˆ°ï¼Œå¤–å±‚<code class=\"language-text\">ParentComponent</code>ä»…ä»…è´Ÿè´£å°†å¼‚æ­¥æ•°æ®ä¼ é€’ç»™äº†å­ç»„ä»¶ï¼Œè€Œå†…éƒ¨ç»„ä»¶<code class=\"language-text\">RenderComponent</code>ä¹Ÿä»…ä»…æ˜¯å°†é™æ€å†…å®¹æ¸²æŸ“æˆäº†domã€‚æ•´ä¸ªå¼‚æ­¥æ•°æ®çš„resolveå’ŒçŠ¶æ€ç»´æŒéƒ½æ”¾åœ¨äº†HOCå†…éƒ¨ã€‚ç»“æ„æ­£å¦‚ä¸€å¼€å§‹çš„å›¾æ‰€æè¿°</strong></p>\n<h1>ğŸš€ æ”¹å†™ä¸ºTypescript</h1>\n<p>ç»è¿‡HOCåŒ…è£¹åçš„ç»„ä»¶ï¼Œç”±æ¥æ”¶åŒæ­¥æ•°æ®å˜ä¸ºæ¥æ”¶å¼‚æ­¥æ•°æ®ï¼Œå…¶Propsçš„typeä¹Ÿå‘ç”Ÿäº†ç›¸åº”çš„æ”¹å˜ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œæˆ‘ä»¬å°†HOCè¿›è¡Œä»¥ä¸‹æ”¹å†™ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">PropsType</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  data<span class=\"token operator\">:</span> PromiseLike<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> | T | null;\n  onDataReady?: (data: T) => void;\n  onDataError?: (e: any) => void;\n  cleanData?: boolean;\n}\n\ninterface StateType</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  dataPromise<span class=\"token operator\">?</span><span class=\"token operator\">:</span> PromiseLike<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> | null;\n  data?: T;\n  lastData?: T;\n  isLoadingData: boolean;\n  dataError?: any;\n}\n\nfunction withAsyncData&lt;ChildPropsType extends </span><span class=\"token punctuation\">{</span> data<span class=\"token operator\">?</span><span class=\"token operator\">:</span> any <span class=\"token punctuation\">}</span><span class=\"token plain-text\">>(Child: ComponentType</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ChildPropsType</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">) </span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// çœŸæ­£çš„data typeæ˜¯ç”±å­ç»„ä»¶å†³å®šçš„</span>\n  type Data <span class=\"token operator\">=</span> ChildPropsType<span class=\"token punctuation\">[</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å°†data typeä»å­ç»„ä»¶çš„propsä¸­åˆ é™¤ï¼Œ HOCæ¥æ”¶çš„å¼‚æ­¥æ•°æ®æœ€ç»ˆtypeä¸ºPromiseLike&lt;Data></span>\n  type MixedPropsType <span class=\"token operator\">=</span> Omit<span class=\"token operator\">&lt;</span>ChildPropsType<span class=\"token punctuation\">,</span> <span class=\"token string\">'data'</span><span class=\"token operator\">></span> <span class=\"token operator\">&amp;</span> PropsType<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">;\n\n  return class WithAsyncData extends Component&lt;MixedPropsType, StateType</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Data</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">> </span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>ä½¿ç”¨æ³›å‹<code class=\"language-text\">&lt;ChildPropsType extends { data?: any }&gt;</code>ä»¥åŠè‡ªåŠ¨ç±»å‹åˆ¤æ–­æ¥å°†è¦æ±‚å­ç»„ä»¶å¿…é¡»æ¥å—<code class=\"language-text\">data</code>å±æ€§</li>\n<li>\n<p><code class=\"language-text\">Omit&lt;ChildPropsType, &#39;data&#39;&gt;</code>å°†data typeä»å­ç»„ä»¶çš„propsä¸­åˆ é™¤ã€‚åœ¨è¾ƒæ–°çš„typescriptä¸­<code class=\"language-text\">Omit</code>å¸®åŠ©ç±»å‹çš„å®šä¹‰åœ¨<code class=\"language-text\">node_modules/typescript/lib/lib.es5.d.ts</code>ä¸­ã€‚å¦‚æœtypescriptç‰ˆæœ¬è¾ƒæ—§æ²¡æœ‰è¯¥å¸®åŠ©ç±»å‹ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œpolyfillï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">declare type Omit<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">K</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> Pick<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> Exclude<span class=\"token operator\">&lt;</span>keyof <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">K</span><span class=\"token operator\">>></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å¦‚ä¸‹å›¾ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨é”™è¯¯çš„promise typeï¼Œé‚£ä¹ˆTypescriptå°±ä¼šæŠ¥é”™ã€‚</p>\n</li>\n</ul>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; '>\n      <a class='gatsby-resp-image-link' href='/static/64cdeb47ab36016f60e175cf6e0fce07/d30ee/error-example.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 24.571428571428573%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVQY032P7W7DIAxF8zIFGmjAGBYS0kzd+7/T7U1XKdI09ceR5Q8O9iBpQ5IKIVOscNLh9BtXWRGIlwWx3hFyx5gW+LzCshYYY9leuSGOvTF8YdC8Q8uKUhfc8kzRHWN9IOiGiRKfGuIRKb/GmdKGy/GYnMJ+Cift0PYgP/B1h3AokVY7cum4TTNMKDBjhvH6wr7j5V2z/uwNRXduww240XicIjMCN7GBgxQ5Yv9gPuSDlAWZ5wpRbRDKj1NdqL+//iP8xBNTGJyQUt2ihQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='ç±»å‹é”™è¯¯' title='ç±»å‹é”™è¯¯' src='/static/64cdeb47ab36016f60e175cf6e0fce07/8c557/error-example.png' srcset='/static/64cdeb47ab36016f60e175cf6e0fce07/4edbd/error-example.png 175w,\n/static/64cdeb47ab36016f60e175cf6e0fce07/13ae7/error-example.png 350w,\n/static/64cdeb47ab36016f60e175cf6e0fce07/8c557/error-example.png 700w,\n/static/64cdeb47ab36016f60e175cf6e0fce07/d30ee/error-example.png 980w' sizes='(max-width: 700px) 100vw, 700px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>","excerpt":"åœ¨Reactä¸­ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨äº†Reduxæˆ–å…¶ä»–çŠ¶æ€ç®¡ç†æ¡†æ¶ï¼Œéƒ½æ— æ³•é¿å…åœ¨ç»„ä»¶ä¸­å¤„ç†å¼‚æ­¥è¯·æ±‚ã€‚åœ¨ä¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œå…¶å…¸å‹çš„æµç¨‹ä¸ºï¼š åœ¨ä¸­å‘èµ·å¼‚æ­¥è¯·æ±‚ è°ƒç”¨åœ¨stateä¸­ç»´æŠ¤è¯·æ±‚çš„loadingçŠ¶æ€ï¼Œå¹¶æ ¹æ®æ­¤çŠ¶æ€æ¸²æŸ“åŠ è½½åŠ¨ç”» åœ¨å¼‚æ­¥è¯·æ±‚resolveçš„æ—¶å€™è°ƒç”¨å°†æ•°æ®æ”¾åˆ°stateä¸­ï¼Œå¹¶å°†loadingçŠ¶æ€ç½®ä¸ºfalseâ€¦","frontmatter":{"date":"September 09, 2019","path":"/with-async-data","title":"åœ¨Reactä¸­å°†å¼‚æ­¥è¯·æ±‚æŠ½è±¡ä¸ºé«˜é˜¶ç»„ä»¶(Typescript)"}}},"pageContext":{}},"staticQueryHashes":["1176552510","3649515864","63159454","846684790"]}